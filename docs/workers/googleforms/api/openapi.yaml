openapi: 3.0.3
info:
  title: Google Forms Worker API
  description: API for handling interactions with Google Forms, enabling registration, validation, and response handling.
  version: 1.0.0
paths:
  /googleforms/v1/register:
    post:
      summary: Register a new Google Form
      description: |
        Registers a new Google Form with a provided key, URL, and handler.
        Includes rate limiting and validation of Google Apps Script origin.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - code
                - formData
              properties:
                key:
                  type: string
                  description: The unique registration key
                code:
                  type: string
                  description: Temporary code generated by Google Apps Script for validation
                formData:
                  type: array
                  description: Form metadata as an array of sections
                  items:
                    type: object
                    required:
                      - sectionTitle
                      - questions
                    properties:
                      sectionTitle:
                        type: string
                        description: Title of the section
                      questions:
                        type: array
                        items:
                          $ref: '#/components/schemas/Question'
      responses:
        '200':
          description: Registration successful
        '400':
          description: Invalid request format
        '404':
          description: Invalid or expired key
        '429':
          description: Rate limit exceeded
        '500':
          description: An error occurred during registration
  /googleforms/v1/validate:
    post:
      summary: Validate a Google Form registration
      description: |
        Validates a Google Form registration by checking the code and ensuring 
        the URL matches the fixed URL. Includes rate limiting.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - code
              properties:
                key:
                  type: string
                  description: The unique registration key
                code:
                  type: string
                  description: The validation code
      responses:
        '200':
          description: Validation successful
        '400':
          description: Invalid code or URL mismatch
        '404':
          description: Invalid or expired key
        '429':
          description: Rate limit exceeded
        '500':
          description: An error occurred during validation
  /googleforms/v1/response:
    post:
      summary: Handle form submissions
      description: |
        Handles form submissions by calling the registered handler with the form data.
        Validates request origin and matches appsScriptId.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - responses
              properties:
                respondentEmail:
                  type: string
                  description: Email of the person who sent the response
                  default: '""'
                responses:
                  type: array
                  items:
                    oneOf:
                      - $ref: '#/components/schemas/MULTIPLE_CHOICE'
                      - $ref: '#/components/schemas/CHECKBOX'
                      - $ref: '#/components/schemas/LIST'
                      - $ref: '#/components/schemas/GRID'
                      - $ref: '#/components/schemas/CHECKBOX_GRID'
                      - $ref: '#/components/schemas/TIME'
                      - $ref: '#/components/schemas/DATE'
                      - $ref: '#/components/schemas/DATETIME'
                      - $ref: '#/components/schemas/SCALE'
                      - $ref: '#/components/schemas/RATING'
                      - $ref: '#/components/schemas/TEXT'
                      - $ref: '#/components/schemas/TEXT_PARAGRAPH'
                      - $ref: '#/components/schemas/DURATION'
      responses:
        '200':
          description: Response handled successfully
        '404':
          description: Resource not found
        '500':
          description: An error occurred while handling the response
  /googleforms/{registrationId}:
    get:
      summary: Serve form setup page
      description: Serves an HTML page that guides users through connecting a Google Form
      parameters:
        - name: registrationId
          in: path
          required: true
          description: The unique registration ID
          schema:
            type: string
      responses:
        '200':
          description: HTML setup page returned successfully
        '404':
          description: Resource not found
components:
  schemas:
    Question:
      type: object
      discriminator:
        propertyName: type
        mapping:
          MULTIPLE_CHOICE: '#/components/schemas/MultipleChoiceQuestion'
          CHECKBOX: '#/components/schemas/MultipleChoiceQuestion'
          LIST: '#/components/schemas/MultipleChoiceQuestion'
          GRID: '#/components/schemas/GridQuestion'
          CHECKBOX_GRID: '#/components/schemas/GridQuestion'
          TIME: '#/components/schemas/TextQuestion'
          DATE: '#/components/schemas/TextQuestion'
          DATETIME: '#/components/schemas/TextQuestion'
          SCALE: '#/components/schemas/TextQuestion'
          RATING: '#/components/schemas/TextQuestion'
          TEXT: '#/components/schemas/TextQuestion'
          PARAGRAPH_TEXT: '#/components/schemas/TextQuestion'
          DURATION: '#/components/schemas/TextQuestion'
      properties:
        id:
          type: integer
          description: Unique identifier for the question
        title:
          type: string
          description: The title of the question
        description:
          type: string
          description: Additional information or help text
        type:
          type: string
          enum:
            - MULTIPLE_CHOICE
            - CHECKBOX
            - LIST
            - GRID
            - CHECKBOX_GRID
            - TIME
            - DATE
            - DATETIME
            - SCALE
            - RATING
            - TEXT
            - PARAGRAPH_TEXT
            - DURATION

    MultipleChoiceQuestion:
      allOf:
        - $ref: '#/components/schemas/Question'
        - type: object
          properties:
            options:
              type: array
              items:
                type: string
              description: List of selectable options
            required:
              type: boolean
              description: Whether the question is mandatory
          required:
            - options
            - required

    GridQuestion:
      allOf:
        - $ref: '#/components/schemas/Question'
        - type: object
          properties:
            rows:
              type: array
              items:
                type: string
              description: Row labels for the grid
            columns:
              type: array
              items:
                type: string
              description: Column labels for the grid
            required:
              type: boolean
              description: Whether the question is mandatory
          required:
            - rows
            - columns
            - required

    TextQuestion:
      allOf:
        - $ref: '#/components/schemas/Question'
        - type: object
          properties:
            required:
              type: boolean
              description: Whether the question is mandatory
          required:
            - required

    MULTIPLE_CHOICE:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: array
          items:
            type: string
          description: Selected options for the multiple-choice question

    CHECKBOX:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: array
          items:
            type: string
          description: Selected options for the checkbox question

    LIST:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: array
          items:
            type: string
          description: Selected options from the list question

    GRID:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: object
          additionalProperties:
            type: string
          description: A map of row labels to selected column labels

    CHECKBOX_GRID:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: object
          additionalProperties:
            type: string
          description: A map of row labels to selected column labels

    TIME:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          format: time
          description: Time value provided for the question

    DATE:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          format: date
          description: Date value provided for the question

    DATETIME:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          format: date-time
          description: Date and time value provided for the question

    SCALE:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: integer
          description: Selected value on the scale

    RATING:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: integer
          description: Selected rating value

    TEXT:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          description: Answer provided as plain text

    TEXT_PARAGRAPH:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          description: Answer provided as plain text

    DURATION:
      type: object
      required:
        - id
        - value
      properties:
        id:
          type: integer
          description: The ID of the question this response references
        value:
          type: string
          format: duration
          description: Duration value provided (ISO 8601 format)